<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auszahlungen - Hexenjäger</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="hexenjaeger-symbol"></div>
            <h1>Auszahlungen</h1>
            <p>Verwalte offene Auszahlungen</p>
            <a href="index.html" class="back-btn">← Zurück zur Übersicht</a>
        </header>

        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-number" id="totalPayouts">0</div>
                <div class="summary-label">Offene Auszahlungen</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalAmount">$0</div>
                <div class="summary-label">Gesamtbetrag</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalMembers">0</div>
                <div class="summary-label">Betroffene Mitglieder</div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button onclick="window.location.href='eingabe.html'" class="btn btn-primary">Neues Event erfassen</button>
        </div>

        <div class="card">
            <h2>Offene Auszahlungen</h2>
            
            <div id="payoutTable" class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Mitglied</th>
                            <th>ID</th>
                            <th>Gesamtbetrag</th>
                            <th>Events</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="payoutBody">
                    </tbody>
                </table>
            </div>
            
            <div id="noPayouts" class="no-data" style="display: none;">
                Keine offenen Auszahlungen vorhanden
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        function loadPayouts() {
            const events = db.getEvents();
            const members = db.getMembers();
            const tbody = document.getElementById('payoutBody');
            const noPayouts = document.getElementById('noPayouts');

            const memberPayouts = calculatePayoutsFromEvents(events, members);

            document.getElementById('totalPayouts').textContent = memberPayouts.length;
            document.getElementById('totalMembers').textContent = memberPayouts.length;
            
            const totalAmount = memberPayouts.reduce((sum, payout) => sum + payout.total, 0);
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);

            if (memberPayouts.length === 0) {
                tbody.innerHTML = '';
                noPayouts.style.display = 'block';
                return;
            }

            noPayouts.style.display = 'none';

            tbody.innerHTML = memberPayouts.map(payout => {
                return `
                    <tr>
                        <td><strong>${payout.memberName}</strong></td>
                        <td><code>${payout.memberId}</code></td>
                        <td><strong style="color: var(--accent-purple);">${formatCurrency(payout.total)}</strong></td>
                        <td>${payout.eventCount} Events</td>
                        <td>
                            <button onclick="completePayout('${payout.memberId}')" class="btn btn-primary">
                                Auszahlen
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculatePayoutsFromEvents(events, members) {
            const memberPayouts = {};
            
            events.forEach(event => {
                const eventType = event.eventType;
                const amount = event.amount || 1;
                const totalAmount = event.totalAmount || 0;
                
                let calculatedAmount = 0;
                
                if (['cayo', 'rp_fabrik', 'ekz'].includes(eventType)) {
                    calculatedAmount = totalAmount > 0 ? Math.round(totalAmount / event.memberIds.length) : 0;
                } else {
                    calculatedAmount = db.getEventPrice(eventType, amount);
                }
                
                event.memberIds.forEach(memberId => {
                    const member = members.find(m => m.id === memberId);
                    if (member) {
                        if (!memberPayouts[memberId]) {
                            memberPayouts[memberId] = {
                                memberId: memberId,
                                memberName: member.name,
                                total: 0,
                                eventCount: 0
                            };
                        }
                        
                        memberPayouts[memberId].total += calculatedAmount;
                        memberPayouts[memberId].eventCount += 1;
                    }
                });
            });
            
            return Object.values(memberPayouts);
        }

        function completePayout(memberId) {
            if (confirm('Auszahlung als erledigt markieren?')) {
                const result = db.completePayout(memberId);
                if (result.success) {
                    showNotification(`Auszahlung für ${formatCurrency(result.amount)} erfolgreich abgeschlossen!`, 'success');
                    loadPayouts();
                } else {
                    showNotification('Fehler: ' + result.error, 'error');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', loadPayouts);
    </script>
</body>
</html>
