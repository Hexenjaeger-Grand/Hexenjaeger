<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Eingabe - Hexenjäger</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .event-form {
            max-width: 1000px;
            margin: 0 auto;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .members-selection {
            margin-top: 15px;
        }

        .selected-count {
            color: var(--accent-purple-light);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .quick-actions {
            margin-bottom: 20px;
        }

        .preview-box {
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .preview-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        .event-details {
            display: none;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="hexenjaeger-symbol">HJ</div>
            <h1>Event Eingabe</h1>
            <p>Schnelle Erfassung für mehrere Mitglieder</p>
            <a href="index.html" class="back-btn">← Zurück zur Übersicht</a>
        </header>

        <div class="card">
            <h2>Neues Event erfassen</h2>
            
            <div class="event-form">
                <!-- Event Typ -->
                <div class="form-section">
                    <label for="eventType">Event Typ</label>
                    <select id="eventType">
                        <option value="">-- Event auswählen --</option>
                        <option value="bizwar_win">Bizwar Win</option>
                        <option value="bizwar_lose">Bizwar Lose</option>
                        <option value="40er_win">40er Win</option>
                        <option value="40er_lose">40er Lose</option>
                        <option value="ekz">EKZ</option>
                        <option value="hafen">Hafen</option>
                        <option value="giesserei">Gießerei</option>
                        <option value="waffenfabrik">Waffenfabrik</option>
                        <option value="cayo">Cayo Perico</option>
                        <option value="rp_fabrik">RP Fabrik</option>
                    </select>
                </div>

                <!-- Mitglieder Auswahl -->
                <div class="form-section">
                    <label>Mitglieder auswählen</label>
                    <div class="quick-actions">
                        <button type="button" class="quick-btn" onclick="selectAllMembers()">Alle auswählen</button>
                        <button type="button" class="quick-btn" onclick="deselectAllMembers()">Alle abwählen</button>
                        <button type="button" class="quick-btn" onclick="selectActiveMembers()">Aktive auswählen</button>
                    </div>
                    <div class="selected-count" id="selectedCount">0 Mitglieder ausgewählt</div>
                    <div class="members-grid" id="membersGrid">
                        <!-- Wird via JavaScript gefüllt -->
                    </div>
                </div>

                <!-- Event Details -->
                <div id="eventDetails" class="event-details">
                    <div class="form-group">
                        <label for="amount" id="amountLabel">Anzahl Kills</label>
                        <input type="number" id="amount" min="1" value="1">
                    </div>
                    
                    <div id="specialAmount" style="display: none;">
                        <div class="form-group">
                            <label for="totalAmount">Gesamtbetrag ($)</label>
                            <input type="number" id="totalAmount" min="1" placeholder="Gesamtbetrag eingeben">
                        </div>
                    </div>
                </div>

                <!-- Vorschau -->
                <div id="previewSection" class="preview-box" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: var(--accent-purple-light);">Vorschau</h3>
                    <div id="previewContent"></div>
                </div>

                <!-- Aktionen -->
                <div style="display: flex; gap: 12px; margin-top: 25px;">
                    <button id="submitEvent" class="btn btn-primary" style="flex: 1;">Event speichern</button>
                    <button onclick="window.location.href='auszahlungen.html'" class="btn btn-secondary">Zu Auszahlungen</button>
                </div>
                
                <div id="statusMessage" style="margin-top: 15px; text-align: center; display: none;"></div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let selectedMembers = [];

        document.addEventListener('DOMContentLoaded', function() {
            const eventType = document.getElementById('eventType');
            const membersGrid = document.getElementById('membersGrid');
            const eventDetails = document.getElementById('eventDetails');
            const submitBtn = document.getElementById('submitEvent');
            const statusMessage = document.getElementById('statusMessage');

            // Lade Mitglieder
            function loadMembers() {
                const members = db.getMembers();
                membersGrid.innerHTML = members.map(member => `
                    <div class="member-tag" data-id="${member.id}" data-name="${member.name}">
                        <input type="checkbox" id="member_${member.id}" style="display: none;">
                        <span>${member.name}</span>
                        <small style="color: var(--text-muted);">(${member.id})</small>
                    </div>
                `).join('');

                // Event Listener für Member Tags
                membersGrid.querySelectorAll('.member-tag').forEach(tag => {
                    tag.addEventListener('click', function() {
                        const memberId = this.dataset.id;
                        const checkbox = this.querySelector('input');
                        
                        if (checkbox.checked) {
                            // Abwählen
                            checkbox.checked = false;
                            this.classList.remove('selected');
                            selectedMembers = selectedMembers.filter(id => id !== memberId);
                        } else {
                            // Auswählen
                            checkbox.checked = true;
                            this.classList.add('selected');
                            selectedMembers.push(memberId);
                        }
                        
                        updateSelectedCount();
                        updatePreview();
                    });
                });
            }

            // Event Type Change
            eventType.addEventListener('change', function() {
                const amountLabel = document.getElementById('amountLabel');
                const specialAmount = document.getElementById('specialAmount');
                
                if (this.value) {
                    eventDetails.style.display = 'block';
                    
                    // Anpassungen für spezielle Events
                    if (this.value === 'cayo') {
                        amountLabel.textContent = 'Anzahl Drops';
                        specialAmount.style.display = 'block';
                    } else if (this.value === 'rp_fabrik') {
                        amountLabel.textContent = 'Anzahl Wins';
                        specialAmount.style.display = 'block';
                    } else {
                        amountLabel.textContent = 'Anzahl Kills';
                        specialAmount.style.display = 'none';
                    }
                } else {
                    eventDetails.style.display = 'none';
                }
                
                updatePreview();
            });

            // Input Listener für Live-Vorschau
            document.getElementById('amount')?.addEventListener('input', updatePreview);
            document.getElementById('totalAmount')?.addEventListener('input', updatePreview);

            // Update ausgewählte Anzahl
            function updateSelectedCount() {
                const count = selectedMembers.length;
                document.getElementById('selectedCount').textContent = `${count} Mitglieder ausgewählt`;
            }

            // Update Vorschau
            function updatePreview() {
                const previewSection = document.getElementById('previewSection');
                const previewContent = document.getElementById('previewContent');
                
                if (!eventType.value || selectedMembers.length === 0) {
                    previewSection.style.display = 'none';
                    return;
                }

                const amount = parseInt(document.getElementById('amount').value) || 1;
                const totalAmount = parseInt(document.getElementById('totalAmount').value) || 0;
                
                let totalPayout = 0;
                let description = '';

                if (eventType.value === 'cayo' || eventType.value === 'rp_fabrik') {
                    if (totalAmount > 0) {
                        const perMember = Math.round(totalAmount / selectedMembers.length);
                        totalPayout = totalAmount;
                        description = `${eventType.value === 'cayo' ? 'Cayo Perico' : 'RP Fabrik'} - ${amount} ${eventType.value === 'cayo' ? 'Drops' : 'Wins'}`;
                        previewContent.innerHTML = `
                            <div class="preview-item">
                                <span>${selectedMembers.length} Mitglieder</span>
                                <span>${formatCurrency(perMember)} pro Person</span>
                            </div>
                            <div class="preview-item">
                                <span>Gesamtbetrag</span>
                                <span><strong>${formatCurrency(totalPayout)}</strong></span>
                            </div>
                        `;
                    }
                } else {
                    const eventPrice = db.getEventPrice(eventType.value, amount);
                    totalPayout = eventPrice * selectedMembers.length;
                    const perMember = eventPrice;
                    
                    const eventNames = {
                        'bizwar_win': 'Bizwar Win', 'bizwar_lose': 'Bizwar Lose',
                        '40er_win': '40er Win', '40er_lose': '40er Lose',
                        'ekz': 'EKZ', 'hafen': 'Hafen',
                        'giesserei': 'Gießerei', 'waffenfabrik': 'Waffenfabrik'
                    };
                    
                    description = `${eventNames[eventType.value]} - ${amount} Kill(s)`;
                    previewContent.innerHTML = `
                        <div class="preview-item">
                            <span>${selectedMembers.length} Mitglieder</span>
                            <span>${formatCurrency(perMember)} pro Person</span>
                        </div>
                        <div class="preview-item">
                            <span>Gesamtbetrag</span>
                            <span><strong>${formatCurrency(totalPayout)}</strong></span>
                        </div>
                    `;
                }

                if (totalPayout > 0) {
                    previewSection.style.display = 'block';
                } else {
                    previewSection.style.display = 'none';
                }
            }

            // Event speichern
            submitBtn.addEventListener('click', function() {
                if (!eventType.value) {
                    showStatus('Bitte Event-Typ auswählen', 'error');
                    return;
                }

                if (selectedMembers.length === 0) {
                    showStatus('Bitte Mitglieder auswählen', 'error');
                    return;
                }

                const amount = parseInt(document.getElementById('amount').value) || 1;
                const totalAmount = parseInt(document.getElementById('totalAmount').value) || 0;

                // Validierung für spezielle Events
                if ((eventType.value === 'cayo' || eventType.value === 'rp_fabrik') && totalAmount === 0) {
                    showStatus('Bitte Gesamtbetrag eingeben', 'error');
                    return;
                }

                const eventData = {
                    eventType: eventType.value,
                    memberIds: selectedMembers,
                    amount: amount,
                    totalAmount: totalAmount
                };

                const result = db.addEvent(eventData);
                if (result.success) {
                    showStatus(`Event für ${selectedMembers.length} Mitglieder gespeichert! Gesamt: ${formatCurrency(result.calculatedAmount)}`, 'success');
                    setTimeout(() => {
                        window.location.href = 'auszahlungen.html';
                    }, 1500);
                } else {
                    showStatus('Fehler: ' + result.error, 'error');
                }
            });

            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.style.color = type === 'success' ? '#10b981' : '#ef4444';
                statusMessage.style.display = 'block';
                setTimeout(() => statusMessage.style.display = 'none', 4000);
            }

            loadMembers();
        });

        // Globale Funktionen für Quick Actions
        function selectAllMembers() {
            const members = db.getMembers();
            selectedMembers = members.map(m => m.id);
            
            document.querySelectorAll('.member-tag').forEach(tag => {
                tag.classList.add('selected');
                tag.querySelector('input').checked = true;
            });
            
            updateSelectedCount();
            updatePreview();
        }

        function deselectAllMembers() {
            selectedMembers = [];
            document.querySelectorAll('.member-tag').forEach(tag => {
                tag.classList.remove('selected');
                tag.querySelector('input').checked = false;
            });
            updateSelectedCount();
            updatePreview();
        }

        function selectActiveMembers() {
            // Hier könntest du Logik für "aktive Mitglieder" implementieren
            // Für jetzt wählen wir einfach die ersten 10 aus
            const members = db.getMembers();
            selectedMembers = members.slice(0, 10).map(m => m.id);
            
            document.querySelectorAll('.member-tag').forEach(tag => {
                const memberId = tag.dataset.id;
                if (selectedMembers.includes(memberId)) {
                    tag.classList.add('selected');
                    tag.querySelector('input').checked = true;
                } else {
                    tag.classList.remove('selected');
                    tag.querySelector('input').checked = false;
                }
            });
            
            updateSelectedCount();
            updatePreview();
        }
    </script>
</body>
</html>
