<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Eingabe - Hexenj√§ger</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .multi-select-container {
            position: relative;
        }
        
        .selected-members {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            min-height: 40px;
        }
        
        .member-chip {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid var(--accent-purple);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .remove-chip {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-chip:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .event-specific {
            display: none;
        }
        
        .info-text {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 5px;
        }
        
        #memberSelect {
            height: auto;
            min-height: 120px;
        }
        
        #memberSelect option {
            padding: 8px 12px;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìù Event Eingabe</h1>
            <a href="index.html" class="back-btn">‚Üê Zur√ºck</a>
        </header>

        <div class="event-form">
            <div>
                <label for="eventType">Event Typ</label>
                <select id="eventType">
                    <option value="">Event ausw√§hlen</option>
                    <option value="bizwar_win">Bizwar Win/Kill</option>
                    <option value="bizwar_lose">Bizwar Lose/Kill</option>
                    <option value="40er_win">40er Win/Kill</option>
                    <option value="40er_lose">40er Lose/Kill</option>
                    <option value="ekz">EKZ Win</option>
                    <option value="hafen">Hafen Drop</option>
                    <option value="giesserei">Gie√üerei Kill</option>
                    <option value="waffenfabrik">Waffenfabrik Kill</option>
                    <option value="cayo">Cayo Perico Drop</option>
                    <option value="rp_fabrik">RP Fabrik Win</option>
                </select>
            </div>

            <div class="multi-select-container">
                <label for="memberSelect">Teilnehmer (Mehrfachauswahl m√∂glich)</label>
                <select id="memberSelect" multiple size="5">
                    <!-- Mitglieder werden hier geladen -->
                </select>
                <div class="info-text">Halte Strg/Cmd gedr√ºckt f√ºr Mehrfachauswahl</div>
                <div class="selected-members" id="selectedMembers">
                    <!-- Ausgew√§hlte Mitglieder werden hier angezeigt -->
                </div>
            </div>

            <!-- Normale Events: Kills/Drops -->
            <div id="normalEvent" class="event-specific">
                <label for="amount">Anzahl Kills/Drops</label>
                <input type="number" id="amount" placeholder="z.B. 5 f√ºr 5 Kills">
            </div>

            <!-- Cayo Perico: Gesamtbetrag und Drops -->
            <div id="cayoEvent" class="event-specific">
                <label for="cayoDrops">Anzahl eingenommene Drops/Zones</label>
                <input type="number" id="cayoDrops" placeholder="Anzahl Drops">
                <label for="cayoTotalAmount">Gesamtbetrag ($)</label>
                <input type="number" id="cayoTotalAmount" placeholder="z.B. 1000000 f√ºr 1 Million">
                <div class="info-text">Der Betrag wird gleichm√§√üig auf alle ausgew√§hlten Mitglieder aufgeteilt</div>
            </div>

            <!-- RP Fabrik: Gesamtbetrag -->
            <div id="rpEvent" class="event-specific">
                <label for="rpTotalAmount">Gesamtbetrag ($)</label>
                <input type="number" id="rpTotalAmount" placeholder="z.B. 8000000 f√ºr 8 Millionen">
                <div class="info-text">Der Betrag wird gleichm√§√üig auf alle ausgew√§hlten Mitglieder aufgeteilt</div>
            </div>

            <button id="submitEvent" class="btn-primary">Event speichern</button>
            <div id="statusMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // Datenbank Funktionen (vereinfacht)
        class SimpleDB {
            getMembers() {
                return JSON.parse(localStorage.getItem('hexenjaeger_members') || '[]');
            }
            
            addEvent(eventData) {
                const { eventType, memberId, amount, totalAmount } = eventData;
                const members = this.getMembers();
                const payouts = JSON.parse(localStorage.getItem('hexenjaeger_payouts') || '[]');
                
                const member = members.find(m => m.id === memberId);
                if (!member) return { error: 'Mitglied nicht gefunden' };
                
                // Event-Preise
                const EVENT_PRICES = {
                    'bizwar_win': 20000, 'bizwar_lose': 10000,
                    '40er_win': 40000, '40er_lose': 20000,
                    'ekz': 80000, 'hafen': 40000,
                    'giesserei': 10000, 'waffenfabrik': 10000,
                    'cayo': 0, 'rp_fabrik': 0
                };
                
                let payout = payouts.find(p => p.memberId === memberId);
                if (!payout) {
                    payout = {
                        memberId,
                        memberName: member.name,
                        bizwar_win: 0, bizwar_lose: 0,
                        '40er_win': 0, '40er_lose': 0,
                        giesserei: 0, waffenfabrik: 0,
                        hafen: 0, cayo: 0, rp_fabrik: 0, ekz: 0,
                        total: 0
                    };
                    payouts.push(payout);
                }
                
                // Berechne Betrag
                let calculatedAmount = 0;
                if (eventType === 'cayo' || eventType === 'rp_fabrik') {
                    calculatedAmount = Math.round(totalAmount / amount);
                } else {
                    calculatedAmount = EVENT_PRICES[eventType] * amount;
                }
                
                payout[eventType] += parseInt(amount);
                payout.total += calculatedAmount;
                
                localStorage.setItem('hexenjaeger_payouts', JSON.stringify(payouts));
                return { success: true, calculatedAmount };
            }
        }

        const db = new SimpleDB();

        // Event Formular mit Mehrfachauswahl
        document.addEventListener('DOMContentLoaded', function() {
            const eventType = document.getElementById('eventType');
            const memberSelect = document.getElementById('memberSelect');
            const selectedMembers = document.getElementById('selectedMembers');
            const normalEvent = document.getElementById('normalEvent');
            const cayoEvent = document.getElementById('cayoEvent');
            const rpEvent = document.getElementById('rpEvent');
            const submitBtn = document.getElementById('submitEvent');
            const statusMessage = document.getElementById('statusMessage');

            let selectedMemberIds = [];

            // F√ºlle Mitglieder Select
            function loadMembers() {
                const members = db.getMembers();
                console.log('Geladene Mitglieder:', members); // Debug
                
                if (members.length === 0) {
                    memberSelect.innerHTML = '<option value="">Keine Mitglieder vorhanden - Bitte zuerst Mitglieder anlegen</option>';
                    return;
                }
                
                memberSelect.innerHTML = '<option value="">Mitglieder ausw√§hlen</option>' +
                    members.map(m => `<option value="${m.id}">${escapeHtml(m.name)} (${m.id})</option>`).join('');
            }

            // Event Type Change
            eventType.addEventListener('change', function() {
                console.log('Event ge√§ndert zu:', this.value); // Debug
                
                // Verstecke alle Event-spezifischen Felder
                normalEvent.style.display = 'none';
                cayoEvent.style.display = 'none';
                rpEvent.style.display = 'none';

                // Zeige die richtigen Felder basierend auf Event-Typ
                switch(this.value) {
                    case 'cayo':
                        cayoEvent.style.display = 'block';
                        break;
                    case 'rp_fabrik':
                        rpEvent.style.display = 'block';
                        break;
                    case '':
                        // Nichts anzeigen
                        break;
                    default:
                        normalEvent.style.display = 'block';
                        break;
                }
            });

            // Mehrfachauswahl Handling
            memberSelect.addEventListener('change', function() {
                console.log('Mitglieder auswahl ge√§ndert'); // Debug
                
                selectedMemberIds = Array.from(this.selectedOptions)
                    .map(option => option.value)
                    .filter(value => value !== ''); // Leere Option ausschlie√üen

                console.log('Ausgew√§hlte IDs:', selectedMemberIds); // Debug
                updateSelectedMembersDisplay();
            });

            function updateSelectedMembersDisplay() {
                const members = db.getMembers();
                selectedMembers.innerHTML = '';

                selectedMemberIds.forEach(memberId => {
                    const member = members.find(m => m.id === memberId);
                    if (member) {
                        const chip = document.createElement('div');
                        chip.className = 'member-chip';
                        chip.innerHTML = `
                            ${escapeHtml(member.name)}
                            <button class="remove-chip" data-id="${memberId}">√ó</button>
                        `;
                        selectedMembers.appendChild(chip);
                    }
                });

                // Entfernen-Buttons Event Listener
                selectedMembers.querySelectorAll('.remove-chip').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const idToRemove = this.getAttribute('data-id');
                        selectedMemberIds = selectedMemberIds.filter(id => id !== idToRemove);
                        
                        // Entferne auch aus Select
                        const option = memberSelect.querySelector(`option[value="${idToRemove}"]`);
                        if (option) option.selected = false;
                        
                        updateSelectedMembersDisplay();
                    });
                });
            }

            // Submit Event
            submitBtn.addEventListener('click', function() {
                const eventTypeValue = eventType.value;
                
                // Validierung
                if (!eventTypeValue) {
                    showStatus('Bitte w√§hle einen Event-Typ aus!', 'error');
                    return;
                }

                if (selectedMemberIds.length === 0) {
                    showStatus('Bitte w√§hle mindestens ein Mitglied aus!', 'error');
                    return;
                }

                // Sammle Event-Daten basierend auf Typ
                let eventData = {
                    eventType: eventTypeValue,
                    memberIds: [...selectedMemberIds] // Kopie des Arrays
                };

                // F√ºge typspezifische Daten hinzu
                switch(eventTypeValue) {
                    case 'cayo':
                        const cayoDrops = parseInt(document.getElementById('cayoDrops').value) || 0;
                        const cayoTotal = parseInt(document.getElementById('cayoTotalAmount').value) || 0;
                        
                        if (!cayoDrops || !cayoTotal) {
                            showStatus('Bitte f√ºlle alle Felder f√ºr Cayo Perico aus!', 'error');
                            return;
                        }
                        
                        eventData.amount = cayoDrops;
                        eventData.totalAmount = cayoTotal;
                        break;

                    case 'rp_fabrik':
                        const rpTotal = parseInt(document.getElementById('rpTotalAmount').value) || 0;
                        
                        if (!rpTotal) {
                            showStatus('Bitte gib den Gesamtbetrag f√ºr RP Fabrik ein!', 'error');
                            return;
                        }
                        
                        eventData.amount = 1; // Immer 1 f√ºr RP Fabrik Win
                        eventData.totalAmount = rpTotal;
                        break;

                    default:
                        const amount = parseInt(document.getElementById('amount').value) || 0;
                        
                        if (!amount) {
                            showStatus('Bitte gib die Anzahl Kills/Drops ein!', 'error');
                            return;
                        }
                        
                        eventData.amount = amount;
                        break;
                }

                // Speichere Event f√ºr alle ausgew√§hlten Mitglieder
                let successCount = 0;
                let errorMessages = [];

                selectedMemberIds.forEach(memberId => {
                    const singleEventData = {
                        eventType: eventData.eventType,
                        memberId: memberId,
                        amount: eventData.amount,
                        totalAmount: eventData.totalAmount || 0
                    };

                    const result = db.addEvent(singleEventData);
                    if (result.success) {
                        successCount++;
                    } else {
                        errorMessages.push(result.error);
                    }
                });

                // Zeige Ergebnis
                if (successCount > 0) {
                    let message = `Event erfolgreich f√ºr ${successCount} Mitglieder gespeichert!`;
                    if (errorMessages.length > 0) {
                        message += ` Fehler: ${errorMessages.join(', ')}`;
                    }
                    showStatus(message, 'success');
                    
                    // Formular zur√ºcksetzen
                    resetForm();
                } else {
                    showStatus('Fehler: ' + errorMessages.join(', '), 'error');
                }
            });

            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.style.color = type === 'success' ? '#10b981' : '#ef4444';
                statusMessage.style.fontWeight = 'bold';

                // Nach 5 Sekenden ausblenden
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 5000);
            }

            function resetForm() {
                eventType.value = '';
                memberSelect.selectedIndex = 0;
                selectedMemberIds = [];
                updateSelectedMembersDisplay();
                
                // Felder zur√ºcksetzen
                document.getElementById('amount').value = '';
                document.getElementById('cayoDrops').value = '';
                document.getElementById('cayoTotalAmount').value = '';
                document.getElementById('rpTotalAmount').value = '';
                
                // Event-spezifische Felder verstecken
                normalEvent.style.display = 'none';
                cayoEvent.style.display = 'none';
                rpEvent.style.display = 'none';
            }

            // Hilfsfunktion
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Initialisierung - SOFORT beim Laden
            console.log('Starte Initialisierung...'); // Debug
            loadMembers();
            console.log('Initialisierung abgeschlossen'); // Debug
        });
    </script>
</body>
</html>
